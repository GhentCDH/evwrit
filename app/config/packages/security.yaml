imports:
  # Import Keycloak security providers
  - { resource: '@IDCIKeycloakSecurityBundle/Resources/config/security.yaml' }

security:
#  enable_authenticator_manager: true
  providers:
    custom_keycloak_bearer:
      id: App\Security\User\CustomKeycloakBearerUserProvider

  firewalls:

    annotation_flow:
      pattern: ^/api
      stateless: true  # Important: no session for API
      provider: custom_keycloak_bearer # Use custom user provider
      entry_point: IDCI\Bundle\KeycloakSecurityBundle\Security\EntryPoint\BearerAuthenticationEntryPoint
      custom_authenticators:
        - IDCI\Bundle\KeycloakSecurityBundle\Security\Authenticator\KeycloakBearerAuthenticator

    main:
      pattern: ^/
      provider: idci_keycloak_security_provider
      entry_point: App\Security\EntryPoint\CustomAuthenticationEntryPoint
      custom_authenticators:
        - IDCI\Bundle\KeycloakSecurityBundle\Security\Authenticator\KeycloakAuthenticator
      logout:
        path: idci_keycloak_security_auth_logout

  access_control:
    # Allow web profiler in dev environment without authentication
    - { path: ^/_profiler, roles: PUBLIC_ACCESS }
    - { path: ^/_wdt, roles: PUBLIC_ACCESS }

    # Allow OPTIONS requests (CORS preflight) without authentication
    - { path: ^/api, methods: [OPTIONS], allow_if: "true" }

    # Keycloak authentication routes - public access
    - { path: ^/auth, roles: PUBLIC_ACCESS }
    - { path: ^/login, roles: PUBLIC_ACCESS }
    - { path: ^/logout, roles: PUBLIC_ACCESS }
    - { path: ^/user, roles: PUBLIC_ACCESS }

    # API endpoints - require ROLE_EDITOR
    - { path: ^/api, roles: ROLE_EDITOR }

    # All other routes - require authentication (any role)
    - { path: ^/, roles: IS_AUTHENTICATED_FULLY }

